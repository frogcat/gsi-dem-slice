<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>gsi-dem-slice</title>
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
<link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script>
	(function(window) {
		var llz2zxy = function(lat, lon, z) {
			var r = lat * Math.PI / 180
			var n = Math.pow(2, z);
			var x = n * ((lon + 180) / 360);
			var y = n * (1 - (Math.log(Math.tan(r) + 1 / Math.cos(r)) / Math.PI)) / 2;
			return [ z, Math.floor(x), Math.floor(y) ];
		};

		var demurl = function(p, zoom) {
			var zxy = llz2zxy(p.lat, p.lon, Math.min(14, zoom));
			return "http://cyberjapandata.gsi.go.jp/xyz/dem/" + zxy.join("/") + ".txt";
		};

		var loader = function(url) {
			return new Promise(function(resolve, reject) {
				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function() {
					if (xhr.readyState != 4)
						return;
					resolve({
						url : url,
						txt : xhr.responseText
					});
				};
				xhr.open("get", url, true);
				xhr.send();
			});
		};

		window.elevation = function(json, zoom) {
			if (json.encoded_polyline) {
				alert("ToDo : support encoded polyline");
				return;
			}

			var db = {};
			json.shape.forEach(function(p) {
				var url = demurl(p, zoom);
				if (!db[url])
					db[url] = true;
			});

			var promises = [];
			for ( var url in db)
				promises.push(loader(url));

			return new Promise(function(resolve, reject) {
				Promise.all(promises).then(function(data) {
					data.forEach(function(v) {
						db[v.url] = v.txt;
					});

					var height = [];
					json.shape.forEach(function(p) {
						var txt = db[demurl(p, zoom)];
						if (!txt) {
							height.push(-100);
							return;
						}

						var zxy = llz2zxy(p.lat, p.lon, Math.min(14, zoom) + 8);
						var x = zxy[1] % 256;
						var y = zxy[2] % 256;
						var h = parseFloat(txt.split("\n")[y].split(",")[x]);
						height.push(isNaN(h) ? -100 : h);
					});

					resolve({
						shape : json.shape,
						height : height
					});
				});
			});
		};

	})(window);
</script>
<style>
body {
	width: 100%;
	height: 100%;
	overflow: hidden;
}

#map {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	bottom: 200px;
}

#bottom {
	position: absolute;
	left: 0;
	width: 100%;
	height: 200px;
	bottom: 0px;
	background: black;
}
</style>

</head>
<body>
	<div id="map"></div>
	<div id="bottom">
		<canvas width="100%" height="100%" id="canvas"></canvas>
	</div>
	<script>
		var factor = 1;

		var canvas = document.getElementById("canvas");

		var map = L.map("map", {
			zoom : 10,
			center : [ 35.527197, 139.246216 ],
			layers : [ L.tileLayer("http://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png", {
				minZoom : 5,
				maxZoom : 15,
				attribution : "<a href='http://maps.gsi.go.jp/development/'>地理院タイル・色別標高図</a>"
			}) ]
		});

		map.attributionControl.addAttribution("<a href='http://maps.gsi.go.jp/development/'>10mメッシュ標高データ (国土地理院)</a>");

		var onDrag = function() {
			var left = markers[0].getLatLng();
			var right = markers[1].getLatLng();
			if (left.lng > right.lng) {
				var a = left;
				left = right;
				right = a;
			}
			polyline.setLatLngs([ left, right ]);
			handler();
		};

		var update = function() {
			var left = polyline.getLatLngs()[0];
			var right = polyline.getLatLngs()[1];
			var p = map.latLngToContainerPoint(left);
			var q = map.latLngToContainerPoint(right);
			var dx = q.x - p.x;

			var shape = [];
			for (var x = 0; x <= dx; x += factor) {
				shape.push({
					"lat" : left.lat * (1 - x / dx) + right.lat * x / dx,
					"lon" : left.lng * (1 - x / dx) + right.lng * x / dx
				});
			}

			elevation({
				shape : shape
			}, map.getZoom()).then(handler);
		};

		var polyline = L.polyline([ [ 35.363856, 138.731232 ], [ 35.680725, 139.767208 ] ], {
			color : "#f00",
			opacity : 0.9,
			lineCap : "round"
		}).addTo(map);

		var markers = [];
		polyline.getLatLngs().forEach(function(p) {
			markers.push(L.marker(p, {
				draggable : true
			}).on("dragend", update).on("drag", onDrag).addTo(map));
		});

		var handler = function(json) {

			var p = map.latLngToContainerPoint(polyline.getLatLngs()[0]);
			var q = map.latLngToContainerPoint(polyline.getLatLngs()[1]);

			var width = window.innerWidth;
			var height = 200;
			canvas.setAttribute("width", width);
			canvas.setAttribute("height", height);
			var ctx = canvas.getContext('2d');

			ctx.beginPath();
			ctx.lineCap = "round";
			ctx.strokeStyle = "#888";
			ctx.lineWidth = 1.0;
			for (var i = 0; i < 4000; i += 500) {
				var y = height * (1 - i / 4000);
				ctx.moveTo(0, y);
				ctx.lineTo(width, y);
			}
			ctx.moveTo(p.x, 0);
			ctx.lineTo(p.x, height);
			ctx.moveTo(q.x, 0);
			ctx.lineTo(q.x, height);
			ctx.stroke();

			ctx.beginPath();
			ctx.strokeStyle = "#f00";
			ctx.lineWidth = 3.0;

			if (!json)
				return;

			json.height.forEach(function(h, i) {
				var x = p.x + i * (q.x - p.x) / (json.height.length - 1);
				var y = height * (1 - h / 4000);
				if (i == 0)
					ctx.moveTo(x, y);
				else
					ctx.lineTo(x, y);
			});
			ctx.stroke();
		};

		update();
	</script>
</body>
</html>
