<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>gsi-dem-slice</title>
<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
<link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<script src="//cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script>
	(function(window) {

		var load = function(url, dems) {
			return new Promise(function(resolve, reject) {
				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function() {
					if (xhr.readyState != 4)
						return;
					dems.forEach(function(dem) {
						dem.execute(xhr.responseText);
					});
					resolve(xhr.responseText);
				};
				xhr.open("get", url, true);
				xhr.send();
			});
		};

		var DEM = function(lat, lon, z) {
			var r = lat * Math.PI / 180
			var n = Math.pow(2, z);
			var x = Math.floor(n * ((lon + 180) / 360));
			var y = Math.floor(n * (1 - (Math.log(Math.tan(r) + 1 / Math.cos(r)) / Math.PI)) / 2);
			this.lat = lat;
			this.lon = lon;
			this.x = x;
			this.y = y;
			this.z = z;
			this.h = NaN;
			this.src = "http://cyberjapandata.gsi.go.jp/xyz/dem/" + [ z, x, y ].join("/") + ".txt";
			return this;
		};

		DEM.prototype.execute = function(txt) {
			if (txt) {
				var dem = new DEM(this.lat, this.lon, this.z + 8);
				var x = dem.x % 256;
				var y = dem.y % 256;
				this.h = parseFloat(txt.split("\n")[y].split(",")[x]);
			}
		};

		window.elevation = function(json, zoom) {
			if (json.encoded_polyline) {
				alert("ToDo : support encoded polyline");
				return;
			}

			var dems = [];
			var tree = {};
			json.shape.forEach(function(p) {
				var dem = new DEM(p.lat, p.lon, Math.min(14, zoom));
				dems.push(dem);
				if (!tree[dem.src])
					tree[dem.src] = [];
				tree[dem.src].push(dem);
			});
			var promises = [];
			for ( var key in tree)
				promises.push(load(key, tree[key]));

			return new Promise(function(resolve, reject) {
				Promise.all(promises).then(function() {
					var height = [];
					dems.forEach(function(dem) {
						height.push(dem.h);
					});
					resolve({
						shape : json.shape,
						height : height
					});
				});
			});
		};

	})(window);
</script>
<style>
body {
	width: 100%;
	height: 100%;
	overflow: hidden;
}

#map {
	position: absolute;
	top: 0;
	left: 0;
	width: 100%;
	bottom: 200px;
}

#bottom {
	position: absolute;
	left: 0;
	width: 100%;
	height: 200px;
	bottom: 0px;
	background: black;
}
</style>

</head>
<body>
	<div id="map"></div>
	<div id="bottom">
		<canvas width="100%" height="100%" id="canvas"></canvas>
	</div>
	<script>
		var factor = 1;

		var canvas = document.getElementById("canvas");

		var map = L.map("map", {
			zoom : 10,
			center : [ 35.527197, 139.246216 ],
			layers : [ L.tileLayer("http://cyberjapandata.gsi.go.jp/xyz/relief/{z}/{x}/{y}.png", {
				minZoom : 5,
				maxZoom : 15,
				attribution : "<a href='http://maps.gsi.go.jp/development/'>地理院タイル・色別標高図</a>"
			}) ]
		});

		map.attributionControl.addAttribution("<a href='http://maps.gsi.go.jp/development/'>10mメッシュ標高データ (国土地理院)</a>");

		var onDrag = function() {
			var left = markers[0].getLatLng();
			var right = markers[1].getLatLng();
			if (left.lng > right.lng) {
				var a = left;
				left = right;
				right = a;
			}
			polyline.setLatLngs([ left, right ]);
			handler();

		};

		var update = function() {
			var left = polyline.getLatLngs()[0];
			var right = polyline.getLatLngs()[1];
			var p = map.latLngToContainerPoint(left);
			var q = map.latLngToContainerPoint(right);
			var dx = q.x - p.x;

			var shape = [];
			for (var x = 0; x <= dx; x += factor) {
				shape.push({
					"lat" : left.lat * (1 - x / dx) + right.lat * x / dx,
					"lon" : left.lng * (1 - x / dx) + right.lng * x / dx
				});
			}

			elevation({
				shape : shape
			}, map.getZoom()).then(handler);
		};

		var polyline = L.polyline([ [ 35.363856, 138.731232 ], [ 35.680725, 139.767208 ] ], {
			color : "#f00",
			opacity : 0.9,
			lineCap : "round"
		}).addTo(map);

		var markers = [];
		polyline.getLatLngs().forEach(function(p) {
			markers.push(L.marker(p, {
				draggable : true
			}).on("dragend", update).on("drag", onDrag).addTo(map));
		});

		var handler = function(json) {

			var p = map.latLngToContainerPoint(polyline.getLatLngs()[0]);
			var q = map.latLngToContainerPoint(polyline.getLatLngs()[1]);

			var width = window.innerWidth;
			var height = 200;
			canvas.setAttribute("width", width);
			canvas.setAttribute("height", height);
			var ctx = canvas.getContext('2d');

			ctx.beginPath();
			ctx.lineCap = "round";
			ctx.strokeStyle = "#888";
			ctx.lineWidth = 1.0;
			for (var i = 0; i < 4000; i += 500) {
				var y = height * (1 - i / 4000);
				ctx.moveTo(0, y);
				ctx.lineTo(width, y);
			}
			ctx.moveTo(p.x, 0);
			ctx.lineTo(p.x, height);
			ctx.moveTo(q.x, 0);
			ctx.lineTo(q.x, height);
			ctx.stroke();

			ctx.beginPath();
			ctx.strokeStyle = "#f00";
			ctx.lineWidth = 3.0;

			if (!json)
				return;

			json.height.forEach(function(h, i) {
				var x = p.x + i * (q.x - p.x) / (json.height.length - 1);
				var y = height * (1 - h / 4000);
				if (i == 0)
					ctx.moveTo(x, y);
				else
					ctx.lineTo(x, y);
			});
			ctx.stroke();
		};

		update();
	</script>
</body>
</html>
